<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: MrfCommon</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#files">Files</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">MrfCommon</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="files"></a>
Files</h2></td></tr>
<tr class="memitem:mrfFracSynth_8c"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="mrfFracSynth_8c.html">mrfFracSynth.c</a></td></tr>
<tr class="memdesc:mrfFracSynth_8c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Support routines for the Micrel SY87739L Fractional-N Synthesizer. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:gae10824b00b8a005d97c74a11cdc9922b"><td class="memItemLeft" align="right" valign="top">epicsShareExtern epicsStatus&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__mrfCommon.html#gae10824b00b8a005d97c74a11cdc9922b">mrfSetEventClockSpeed</a> (epicsFloat64 InputClockSpeed, epicsUInt32 InputControlWord, epicsFloat64 ReferenceFreq, epicsFloat64 *OutputClockSpeed, epicsUInt32 *OutputControlWord, epicsInt32 PrintFlag)</td></tr>
<tr class="separator:gae10824b00b8a005d97c74a11cdc9922b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gae361c0306ceb8ef7701c8bff663c56e3"><td class="memItemLeft" align="right" valign="top">epicsShareExtern epicsUInt32&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__mrfCommon.html#gae361c0306ceb8ef7701c8bff663c56e3">FracSynthControlWord</a> (epicsFloat64 DesiredFreq, epicsFloat64 ReferenceFreq, epicsInt32 debugFlag, epicsFloat64 *Error)</td></tr>
<tr class="separator:gae361c0306ceb8ef7701c8bff663c56e3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga42a0aecda942f6b758fbace9d8b3cdaa"><td class="memItemLeft" align="right" valign="top">epicsShareExtern epicsFloat64&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__mrfCommon.html#ga42a0aecda942f6b758fbace9d8b3cdaa">FracSynthAnalyze</a> (epicsUInt32 ControlWord, epicsFloat64 ReferenceFreq, epicsInt32 PrintFlag)</td></tr>
<tr class="separator:ga42a0aecda942f6b758fbace9d8b3cdaa"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<h2 class="groupheader">Function Documentation</h2>
<a id="gae10824b00b8a005d97c74a11cdc9922b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gae10824b00b8a005d97c74a11cdc9922b">&#9670;&nbsp;</a></span>mrfSetEventClockSpeed()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">epicsShareExtern epicsStatus mrfSetEventClockSpeed </td>
          <td>(</td>
          <td class="paramtype">epicsFloat64&#160;</td>
          <td class="paramname"><em>InputClockSpeed</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">epicsUInt32&#160;</td>
          <td class="paramname"><em>InputControlWord</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">epicsFloat64&#160;</td>
          <td class="paramname"><em>ReferenceFreq</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">epicsFloat64 *&#160;</td>
          <td class="paramname"><em>OutputClockSpeed</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">epicsUInt32 *&#160;</td>
          <td class="paramname"><em>OutputControlWord</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">epicsInt32&#160;</td>
          <td class="paramname"><em>PrintFlag</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="section user"><dt>Description:</dt><dd></dd></dl>
<p>This routine will determine the system's event clock speed (in Megahertz) and/or the value for the fractional synthesizer control word given at least one of these two values.</p>
<dl class="section user"><dt>Function:</dt><dd></dd></dl>
<p>If the InputClockSpeed parameter is specified (not zero), the routine will compute the value of the fractional synthesizer control word to produce that frequency.</p>
<p>If the InputControlWord parameter is specified (not zero), the routine will check the control word for programming errors and return the actual frequency (in Megahertz) produced by that control word.</p>
<p>If neither parameter is specified, the routine will output a default event clock frequency and a default control word.</p>
<p>If both parameters are specified, the routine will make sure the frequency generated by the control word is within 100 ppm of the desired clock speed.</p>
<p>If no errors are encountered, the routine will return both the final event clock speed and the fractional synthesizer control word. If errors are encountered, both output parameters will contain zero.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">InputClockSpeed</td><td>= (input) Desired event clock speed in Megahertz. 0.0 means no clock speed specified. <br  />
 </td></tr>
    <tr><td class="paramname">InputControlWord</td><td>= (input) Desired value for the fractional synthesizer control word. 0 means no control word specified. </td></tr>
    <tr><td class="paramname">ReferenceFreq</td><td>= (input) SY87739L input reference frequency in MegaHertz. </td></tr>
    <tr><td class="paramname">OutputClockSpeed</td><td>= (output) The input or computed value for the event clock speed </td></tr>
    <tr><td class="paramname">OutputControlWord</td><td>= (output) The input or computed value for the fractional synthesizer control word. </td></tr>
    <tr><td class="paramname">PrintFlag</td><td>= (input) Flag to control output messages. Output levels correspond to the DEBUGPRINT output levels:<br  />
 DP_NONE (0) = Only display errors that prevent us from returning the event clock speed and the control word.<br  />
 DP_ERROR (2) = Display any programming errors detected in the control word.<br  />
 DP_WARN (3) = Display warning messages such as the one warning that we are using the default event clock frequency.<br  />
 DP_INFO (4) = Display the value of the computed control word, its actual output frequency, and the error (in ppm) between the desired and actual frequencies.<br  />
 DP_DEBUG (5) = Display the actual values of the fields in the control word, along with the constituent parts of the output frequency (VCO frequency, correction term, reference freq.)</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>OK if we were able to return both an event clock frequency and a fractional synthesizer control word.<br  />
 ERROR if we could not. </dd></dl>

<p class="reference">References <a class="el" href="group__mrfCommon.html#ga42a0aecda942f6b758fbace9d8b3cdaa">FracSynthAnalyze()</a>, and <a class="el" href="group__mrfCommon.html#gae361c0306ceb8ef7701c8bff663c56e3">FracSynthControlWord()</a>.</p>

</div>
</div>
<a id="gae361c0306ceb8ef7701c8bff663c56e3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gae361c0306ceb8ef7701c8bff663c56e3">&#9670;&nbsp;</a></span>FracSynthControlWord()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">epicsShareExtern epicsUInt32 FracSynthControlWord </td>
          <td>(</td>
          <td class="paramtype">epicsFloat64&#160;</td>
          <td class="paramname"><em>DesiredFreq</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">epicsFloat64&#160;</td>
          <td class="paramname"><em>ReferenceFreq</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">epicsInt32&#160;</td>
          <td class="paramname"><em>debugFlag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">epicsFloat64 *&#160;</td>
          <td class="paramname"><em>Error</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="section user"><dt>Description:</dt><dd></dd></dl>
<p>This routine will take a desired output frequency (expressed in MegaHertz)and a reference frequency (also expressed in MegaHertz) and create a control word for the Micrel SY877391L Fractional-N Synthesizer chip that will produce an output frequency as close as possible to the desired frequency. The routine also returns an error value (expressed in parts-per-million) between the actual output frequency and the desired output frequency.</p>
<dl class="section user"><dt>Function:</dt><dd></dd></dl>
<p>A complete description of how the Micrel SY87739L chip works is way beyond the scope of a function header comment. The reader who wants a complete understanding of what this routine is doing should refer to the Micrel SY87739L product description sheet available at: www.micrel.com</p>
<p>A brief description of the chip programming is useful, however, and is provided here:</p>
<p>The output frequency is described by the following formulae:</p>
<p>F(out) = F(vco) / PostDiv</p>
<p>where F(vco) is the frequency generated by a voltage-controlled oscillator, and PostDiv is a frequency divider value between 1 and 60 (not inclusive). The PostDiv value must be chosen so that the VCO frequency is within its operating range of 540 - 729 MHz. The VCO frequency is given by:</p>
<p>F(vco) = C * F(frac) * F(ref)</p>
<p>where C is a "Correction Factor" (also referred to as the "wrapper correction" in the documentation0 expressed as (N/M) where N and M are from the set {14, 15, 16, 17, 18, 31, 32}. Not all combinations, however, are legal. F(frac) is the fractional frequency produced by a fractional-N P/P-1 divider circuit. F(ref) is the input reference frequency to the Micrel chip. Typically it is 27 MHz, although in the MRF timing boards it is 24 MHz. The fractional frequency is basically a multiplier for the reference frequency. It is expressed as a rational number with a divisor less than 32 and is given by:</p>
<p>F(frac) = P - (Q(p-1) / (Q(p) + Q(p-1)))</p>
<p>where P is the integer part of the fractional frequency, Q(p) is the number of clock periods where the reference clock is divided by P and Q(p-1) is the number of clock periods where the reference clock is divided by P-1. A hardware implementation of Bresenham's algorithm is used to evenly space out the P and P-1 divisions. Beyond this, you'll have to read the manual for further details.</p>
<p>The routine works by doing an exhaustive search (with some optimizations) of the parameter space {C, Q(p), Q(p-1), PostDiv}. P is predetermined by F(out) and PostDiv, so it does not need to be searched. The Q(p), Q(p-1) search is accomplished by searching all the numerators for the denominator (Q(p) + Q(p-1)) that produce a fraction less than 1. Although an exhaustive search is not the most efficient way to optimize a 4-parameter space, it turns out that the dimensions of each parameter are not that big. PostDiv only has 31 unique values, and we only search the values that produce a valid F(vco). When you rule out duplications and illegal combinations it turns out that C only has 22 valid values, and if you arrange them in ascending order, you only have to search until the error value stops decreasing. For Q(p) and Q(p-1), we only have to search 31 denominators and for each denominator we only have to search n-1 numerators. This gives us n(n+1)/2, or 465 (for n=30) possible numerator/denominator pairs to search, although we stop immediately if we find a denominator that exactly divides the desired fractional frequency.</p>
<p>If we search 22 correction factors for each numerator/denominator pair, and we repeat the process for each of 31 possible PostDiv values, we get a worst case number of 317,130 possible combinations. In practice, the VCO frequency limitations (between 540 and 729 Megahertz) will usually eliminate most of the 31 possible PostDiv values. Given the other optimizations mentioned above, the worst case number is a pretty pathological example. In most cases the number of combinations actually searched will be far less than that.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">DesiredFreq</td><td>= (input) Desired output frequency in MegaHertz. </td></tr>
    <tr><td class="paramname">ReferenceFreq</td><td>= (input) SY87739L input reference frequency in MegaHertz. </td></tr>
    <tr><td class="paramname">debugFlag</td><td>= (input) Flag for debug output. If the value is 4 (DP_INFO) or higher, the routine will print the value of the control word and the frequency actually produced. </td></tr>
    <tr><td class="paramname">Error</td><td>= (output) Error between the actual output frequency and the desired output frequency. Expressed in parts-per-million.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section user"><dt>Implicit Inputs:</dt><dd><em>CorrectionList</em> = (CorrectionStruct) List of all valid correction factors and their control-word encodings.<br  />
 <em>PostDivideList</em> = (PostDivideStruct) List of valid post-divide values and their control-word encodings.</dd></dl>
<dl class="section return"><dt>Returns</dt><dd>Returns the SY87739L Control Word for the desired frequency. </dd></dl>

<p class="reference">Referenced by <a class="el" href="classEVRMRM.html#a7255ef34d47e0c3b44924b94278687dc">EVRMRM::clockSet()</a>, and <a class="el" href="group__mrfCommon.html#gae10824b00b8a005d97c74a11cdc9922b">mrfSetEventClockSpeed()</a>.</p>

</div>
</div>
<a id="ga42a0aecda942f6b758fbace9d8b3cdaa"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga42a0aecda942f6b758fbace9d8b3cdaa">&#9670;&nbsp;</a></span>FracSynthAnalyze()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">epicsShareExtern epicsFloat64 FracSynthAnalyze </td>
          <td>(</td>
          <td class="paramtype">epicsUInt32&#160;</td>
          <td class="paramname"><em>ControlWord</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">epicsFloat64&#160;</td>
          <td class="paramname"><em>ReferenceFreq</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">epicsInt32&#160;</td>
          <td class="paramname"><em>PrintFlag</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="section user"><dt>Description:</dt><dd>This routine will take a bit pattern representing an SY87739L fractional synthesizer control word, break it down into its constituent parts, and return the effective output frequency (in MegaHertz) that the control word will generate. Depending on the value of the "PrintFlag" parameter, it will also display the constituent parts of the the control word and the resulting values that make up the output frequency, and analyze the control word for programming errors.</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ControlWord</td><td>= (input) The control word bit pattern to analyze. </td></tr>
    <tr><td class="paramname">ReferenceFreq</td><td>= (input) SY87739L input reference frequency in MegaHertz. </td></tr>
    <tr><td class="paramname">PrintFlag</td><td>= (input) Flag to control output messages. Output levels correspond to the DEBUGPRINT output levels:<br  />
 DP_NONE (0) = No printed output, just return the effective output frequency.<br  />
 DP_ERROR (2) = Display any programming errors detected in the control word<br  />
 DP_DEBUG (5) = Display the actual values of the fields in the control word, along with the constituent parts of the output frequency (VCO frequency, correction term, reference freq.)</td></tr>
  </table>
  </dd>
</dl>
<dl class="section user"><dt>Implicit Inputs:</dt><dd><em>CorrectionValList</em> = (CorrectionValStruct) Array to translate correction term components from their coded values to actual values and classes. <em>PostDivideValList</em> = (epicsInt32) Array to translate the post-divider field from its coded value to its actual value.</dd></dl>
<dl class="section return"><dt>Returns</dt><dd>Returns the output frequency generated by the control word.<br  />
 Returns 0.0 if the analysis discovered programming errors in the control word. </dd></dl>

<p class="reference">Referenced by <a class="el" href="classEVRMRM.html#a7255ef34d47e0c3b44924b94278687dc">EVRMRM::clockSet()</a>, and <a class="el" href="group__mrfCommon.html#gae10824b00b8a005d97c74a11cdc9922b">mrfSetEventClockSpeed()</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
