#! Generated by VisualDCT v2.6
#! DBDSTART
#! DBD("../../dbd/mrf.dbd")
#! DBDEND

# Software gate of EVR output channel
# After some event code (start event)
# wait a preset delay, then enable
# the output, wait a preset width,
# then disable the output.
#
# Must be explicitly armed by writing
# a 1 to $(P)Ena-Sel
#
# Macros:
#  P - PV prefix
#  OBJ - EVR object
#  Code - Start event code
#  ENA - Output enable PV
#


record(longout, "$(P)Evt$(s=:)Start-SP_") {
  field(ASG, "$(ASGPRIVATE=private)")
  field(DTYP, "EVR Event")
  field(OUT, "@OBJ=$(OBJ),Code=$(Code)")
  field(VAL, "-1")
  field(SCAN, "I/O Intr")
  field(TSE, "-2")

  field(PRIO, "HIGH")

  field(SDIS, "$(P)Ena-Sel")
  field(DISV, "0")

  field(FLNK, "$(P)Evt$(s=:)1-Seq_")
}


record(bo, "$(P)Ena-Sel") {
  field(DESC, "Request burst")
  field(ASG,  "$(ASGPROTECTED=protected)")
  field(UDF, "0")
  field(ZNAM, "Idle")
  field(ONAM, "Request Burst")
}

record(ao, "$(P)Delay-SP") {
  field(ASG,  "$(ASGPROTECTED=protected)")
  field(EGU, "us")
  info(autosaveFields_pass0, "VAL")
}

record(ao, "$(P)Width-SP") {
  field(ASG,  "$(ASGPROTECTED=protected)")
  field(EGU, "us")
  info(autosaveFields_pass0, "VAL")
}

record(seq, "$(P)Evt$(s=:)1-Seq_") {
  field(ASG, "$(ASGPRIVATE=private)")
  # First clear request
  field(DOL1, "0")
  field(LNK1, "$(P)Ena-Sel PP")

  # Latch requested delay and width
  field(DOL2, "$(P)Delay-SP")
  field(LNK2, "$(P)Evt$(s=:)2-Seq_.DLY1")
  field(DOL3, "$(P)Width-SP")
  field(LNK3, "$(P)Evt$(s=:)2-Seq_.DLY2")

  field(FLNK, "$(P)Evt$(s=:)2-Seq_")
}

record(seq, "$(P)Evt$(s=:)2-Seq_") {
  field(ASG, "$(ASGPRIVATE=private)")
  # wait DLY1
  # write 1 to enable output
  field(DOL1, "1")
  field(LNK1, "$(ENA) PP")
  # wait DLY2
  # write 0 to disable output
  field(DOL2, "0")
  field(LNK2, "$(ENA) PP")
}

#! Further lines contain data used by VisualDCT
#! View(2179,2300,1.0)
#! Record("$(P)Evt$(s=:)Start-SP_",2100,2186,0,1,"$(P)Evt$(s=:)Start-SP_")
#! Field("$(P)Evt$(s=:)Start-SP_.FLNK",16777215,1,"$(P)Evt$(s=:)Start-SP_.FLNK")
#! Link("$(P)Evt$(s=:)Start-SP_.FLNK","$(P)Evt$(s=:)1-Seq_")
#! Field("$(P)Evt$(s=:)Start-SP_.SDIS",16777215,1,"$(P)Evt$(s=:)Start-SP_.SDIS")
#! Link("$(P)Evt$(s=:)Start-SP_.SDIS","$(P)Ena-Sel.VAL")
#! Record("$(P)Ena-Sel",2380,2522,0,1,"$(P)Ena-Sel")
#! Field("$(P)Ena-Sel.VAL",16777215,1,"$(P)Ena-Sel.VAL")
#! Record("$(P)Delay-SP",2660,2610,0,1,"$(P)Delay-SP")
#! Field("$(P)Delay-SP.VAL",16777215,0,"$(P)Delay-SP.VAL")
#! Record("$(P)Evt$(s=:)1-Seq_",2680,2246,0,0,"$(P)Evt$(s=:)1-Seq_")
#! Field("$(P)Evt$(s=:)1-Seq_.FLNK",16777215,1,"$(P)Evt$(s=:)1-Seq_.FLNK")
#! Link("$(P)Evt$(s=:)1-Seq_.FLNK","$(P)Evt$(s=:)2-Seq_")
#! Field("$(P)Evt$(s=:)1-Seq_.LNK1",16777215,0,"$(P)Evt$(s=:)1-Seq_.LNK1")
#! Link("$(P)Evt$(s=:)1-Seq_.LNK1","$(P)Ena-Sel.VAL")
#! Field("$(P)Evt$(s=:)1-Seq_.DOL2",16777215,0,"$(P)Evt$(s=:)1-Seq_.DOL2")
#! Link("$(P)Evt$(s=:)1-Seq_.DOL2","$(P)Delay-SP.VAL")
#! Field("$(P)Evt$(s=:)1-Seq_.LNK2",16777215,1,"$(P)Evt$(s=:)1-Seq_.LNK2")
#! Link("$(P)Evt$(s=:)1-Seq_.LNK2","$(P)Evt$(s=:)2-Seq_.DLY1")
#! Field("$(P)Evt$(s=:)1-Seq_.DOL3",16777215,0,"$(P)Evt$(s=:)1-Seq_.DOL3")
#! Link("$(P)Evt$(s=:)1-Seq_.DOL3","$(P)Width-SP.VAL")
#! Field("$(P)Evt$(s=:)1-Seq_.LNK3",16777215,1,"$(P)Evt$(s=:)1-Seq_.LNK3")
#! Link("$(P)Evt$(s=:)1-Seq_.LNK3","$(P)Evt$(s=:)2-Seq_.DLY2")
#! Record("$(P)Width-SP",2660,2830,0,1,"$(P)Width-SP")
#! Field("$(P)Width-SP.VAL",16777215,0,"$(P)Width-SP.VAL")
#! Record("$(P)Evt$(s=:)2-Seq_",3000,2368,0,0,"$(P)Evt$(s=:)2-Seq_")
#! Field("$(P)Evt$(s=:)2-Seq_.DLY1",16777215,0,"$(P)Evt$(s=:)2-Seq_.DLY1")
#! Field("$(P)Evt$(s=:)2-Seq_.LNK1",16777215,1,"$(P)Evt$(s=:)2-Seq_.LNK1")
#! Field("$(P)Evt$(s=:)2-Seq_.DLY2",16777215,0,"$(P)Evt$(s=:)2-Seq_.DLY2")
#! Field("$(P)Evt$(s=:)2-Seq_.LNK2",16777215,1,"$(P)Evt$(s=:)2-Seq_.LNK2")
