# Base record set for an EVR
#
# Macros:
#  P = record name prefix
#  OBJ = devObj name
#  EVNT1HZ = DB event number for the 1 second tick

record(bo, "$(P)enable") {
  field(DTYP, "Obj Prop bool")
  field(OUT , "@OBJ=$(OBJ), PROP=Enable")
  field(DESC, "Master enable for EVR device")
  field(MASK, "1")
  field(ZNAM, "Disabled")
  field(ONAM, "Enabled")
  info(autosaveFields_pass0, "VAL")
}

record(longin, "$(P)link:timo") {
  field(DTYP, "Obj Prop uint32")
  field(INP , "@OBJ=$(OBJ), PROP=HB Timeout Count")
  field(SCAN, "I/O Intr")
  field(DESC, "# of heartbeat timeout")
}

record(bo, "$(P)ext:inhib") {
  field(DTYP, "Obj Prop bool")
  field(OUT , "@OBJ=$(OBJ), PROP=External Inhibit")
  field(PINI, "YES")
  field(DESC, "Use HW trigger inhibit (EVRTG only)")
  field(MASK, "1")
  field(ZNAM, "Use Inhibit")
  field(ONAM, "Always Permit")
  field(OSV, "MINOR")
  info(autosaveFields_pass0, "VAL")
}

record(bi, "$(P)link:sts") {
  field(DTYP, "Obj Prop bool")
  field(INP , "@OBJ=$(OBJ), PROP=Link Status")
  field(DESC, "Status of event link")
  field(SCAN, "1 second")
  field(ZNAM, "Fail")
  field(ONAM, "OK")
  field(ZSV , "MAJOR")
  field(FLNK, "$(P)link:cnt")
}

record(longin, "$(P)link:cnt") {
  field(DTYP, "Obj Prop uint32")
  field(DESC, "Receive Error Count")
  field(INP , "@OBJ=$(OBJ), PROP=Receive Error Count")
  field(DESC, "Rx error count")
  field(TSEL, "$(P)link:sts.TIME")
  field(FLNK, "$(P)fifo:cnt")
}

record(longin, "$(P)fifo:cnt") {
  field(DTYP, "Obj Prop uint32")
  field(DESC, "FIFO Hw Overflow Count")
  field(INP , "@OBJ=$(OBJ), PROP=FIFO Overflow Count")
  field(TSEL, "$(P)link:cnt.TIME")
  field(FLNK, "$(P)fiforate:cnt")
}

record(longin, "$(P)fiforate:cnt") {
  field(DTYP, "Obj Prop uint32")
  field(DESC, "FIFO Sw Overrate Count")
  field(INP , "@OBJ=$(OBJ), PROP=FIFO Over rate")
  field(TSEL, "$(P)link:cnt.TIME")
  field(FLNK, "$(P)link:sts:init")
}

# Detect the first time the event link
# is online.  Then set master enable.
record(calcout, "$(P)link:sts:init") {
  field(DESC, "Detect initial link up")
  field(INPA, "$(P)link:sts")
  field(CALC, "A")
  field(OUT , "$(P)enable PP")
  field(OOPT, "Transition To Non-zero")
  field(ODLY, "1.0")
  field(TSEL, "$(P)link:sts.TIME")
}

record(ao, "$(P)clock:set") {
  field(DTYP, "Obj Prop double")
  field(OUT , "@OBJ=$(OBJ), PROP=Clock")
  field(PINI, "YES")
  field(DESC, "Event Link speed")
  field(VAL , "124.916")
  field(EGU , "MHz")
  field(LINR, "LINEAR")
  field(ESLO, "1e-6")
  field(HOPR, "150")
  field(LOPR, "50")
  field(DRVH, "150")
  field(DRVL, "50")
  field(PREC, "3")
  field(FLNK, "$(P)clock")
  info(autosaveFields_pass0, "VAL EGU ESLO HOPR LOPR DRVH DRVL PREC")
}

record(ai, "$(P)clock") {
  field(DTYP, "Obj Prop double")
  field(INP , "@OBJ=$(OBJ), PROP=Clock")
  field(DESC, "Event Link speed")
  field(PINI, "YES")
  field(UDF , "0")
  field(EGU , "MHz")
  field(LINR, "LINEAR")
  field(ESLO, "1e-6")
  field(PREC, "3")
  field(FLNK, "$(P)clock:error")
  info(autosaveFields_pass0, "EGU ESLO HOPR LOPR PREC")
}

record(calc, "$(P)clock:error") {
  field(CALC, "(A-B)*1000")
  field(EGU , "KHz")
  field(PREC, "3")
  field(INPA, "$(P)clock:set")
  field(INPB, "$(P)clock")
  field(TSEL, "$(P)clock.TIME")
  field(FLNK, "$(P)clock:period")
  info(autosaveFields_pass0, "EGU CALC PREC")
}

# Intended for use in calculations
record(calc, "$(P)clock:period") {
  field(DESC, "Event period")
  field(CALC, "B/A")
  field(EGU , "s")
  field(PREC, "3")
  field(INPA, "$(P)clock:set")
  field(INPB, "$(P)clock:set.ESLO")
  field(TSEL, "$(P)clock.TIME")
}

record(bi, "$(P)pll") {
  field(DTYP, "Obj Prop bool")
  field(INP , "@OBJ=$(OBJ), PROP=PLL Lock Status")
  field(SCAN, "1 second")
  field(PINI, "YES")
  field(DESC, "Status of PLL")
  field(ZNAM, "Error")
  field(ONAM, "OK")
  field(ZSV , "MAJOR")
}

record(longin, "$(P)hwtype") {
  field(DTYP, "Obj Prop uint32")
  field(INP , "@OBJ=$(OBJ), PROP=Model")
  field(PINI, "YES")
  field(DESC, "Hardware type code")
}

record(longin, "$(P)ver") {
  field(DTYP, "Obj Prop uint32")
  field(INP , "@OBJ=$(OBJ), PROP=Version")
  field(PINI, "YES")
  field(DESC, "Firmware version")
}

record(fanout, "$(P)ts:init") {
  field(PINI, "YES")
  field(LNK1, "$(P)ts:clock:set")
  field(LNK2, "$(P)ts:source")
}

record(bi, "$(P)ts:valid") {
  field(DTYP, "Obj Prop bool")
  field(INP , "@OBJ=$(OBJ), PROP=Timestamp Valid")
  field(PINI, "YES")
  field(SCAN, "I/O Intr")
  field(ZSV , "MAJOR")
  field(ZNAM, "Invalid")
  field(ONAM, "Valid")
}

record(mbbo, "$(P)ts:source") {
  field( DTYP, "Raw Soft Channel")
  field( OUT , "$(P)ts:source:raw")
  field( PINI, "YES")
  field( ZRST, "Event clock")
  field( ONST, "Mapped code(s)")
  field( TWST, "DBus 4")
  field( ZRVL, "0")
  field( ONVL, "1")
  field( TWVL, "2")
  field( THSV, "INVALID")
  field( FRSV, "INVALID")
  field( FVSV, "INVALID")
  field( SXSV, "INVALID")
  field( SVSV, "INVALID")
  field( EISV, "INVALID")
  field( NISV, "INVALID")
  field( TESV, "INVALID")
  field( ELSV, "INVALID")
  field( TVSV, "INVALID")
  field( TTSV, "INVALID")
  field( FTSV, "INVALID")
  field( FFSV, "INVALID")
  field( UNSV, "INVALID")
  field( IVOA, "Don't drive outputs")
  field(FLNK, "$(P)ts:source:raw")
  info(autosaveFields_pass0, "VAL")
}

record(longout, "$(P)ts:source:raw") {
  field(DTYP, "Obj Prop uint32")
  field(OUT , "@OBJ=$(OBJ), PROP=Timestamp Source")
  field(FLNK, "$(P)ts:clock")
}

record(ao, "$(P)ts:clock:set") {
  field(DTYP, "Obj Prop double")
  field(OUT , "@OBJ=$(OBJ), PROP=Timestamp Clock")
  field(DESC, "Timestamp tick rate")
  field(VAL , "0.0")
  field(EGU , "MHz")
  field(LINR, "LINEAR")
  field(ESLO, "1e-6")
  field(HOPR, "150")
  field(LOPR, "0")
  field(DRVH, "150")
  field(DRVL, "0")
  field(PREC, "3")
  field(FLNK, "$(P)ts:clock")
  info(autosaveFields_pass0, "VAL EGU ESLO HOPR LOPR DRVH DRVL PREC")
}

record(ai, "$(P)ts:clock") {
  field(DTYP, "Obj Prop double")
  field(INP , "@OBJ=$(OBJ), PROP=Timestamp Clock")
  field(SCAN, "1 second")
  field(DESC, "Timestamp tick rate")
  field(PINI, "YES")
  field(UDF , "0")
  field(EGU , "MHz")
  field(LINR, "LINEAR")
  field(ESLO, "1e-6")
  field(HOPR, "150")
  field(LOPR, "0")
  field(PREC, "3")
  field(FLNK, "$(P)ts:div")
}

record(longin, "$(P)ts:div") {
  field(DTYP, "Obj Prop uint32")
  field(INP , "@OBJ=$(OBJ), PROP=Timestamp Prescaler")
  field(DESC, "Timestamp divider")
}

record(stringin, "$(P)ts") {
  field(DTYP, "EVR Timestamp")
  field(INP , "@OBJ=$(OBJ)")
  field(SCAN, "Event")
  field(EVNT, "$(EVNT1HZ)")
}

record(bo, "$(P)dbus:recv:mode") {
  field(DESC, "Downstream data mode")
  field(DTYP, "Obj Prop bool")
  field(OUT , "@OBJ=$(OBJ):BUFRX, PROP=Enable")
  field(PINI, "YES")
  field(VAL , "1")
  field(ZNAM, "DBus only")
  field(ONAM, "DBus+Buffer")
  info(autosaveFields_pass0, "VAL")
}

