<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: mrfioc2 Timing System Driver for MRF products</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">mrfioc2 Timing System Driver for MRF products </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="whatisit"></a>
What is it?</h1>
<p>A driver for VME and PCI cards from Micro Research Finland for event timing systems.</p>
<p>@url <a href="http://www.mrf.fi/">http://www.mrf.fi/</a></p>
<h1><a class="anchor" id="whereis"></a>
Source</h1>
<p>Releases can be found at @url <a href="http://sourceforge.net/projects/epics/files/mrfioc2/">http://sourceforge.net/projects/epics/files/mrfioc2/</a></p>
<p>This module is versioned with Git and can be viewed at @url <a href="https://github.com/epics-modules/mrfioc2/">https://github.com/epics-modules/mrfioc2/</a></p>
<p>Or checked out with</p>
<p>git clone <a href="https://github.com/epics-modules/mrfioc2.git">https://github.com/epics-modules/mrfioc2.git</a></p>
<p>The canonical version of this page is @url <a href="http://epics.sourceforge.net/mrfioc2/">http://epics.sourceforge.net/mrfioc2/</a></p>
<h2><a class="anchor" id="requires"></a>
Requires</h2>
<p>EPICS Base &gt;= 3.14.10</p>
<p>@url <a href="http://www.aps.anl.gov/epics/">http://www.aps.anl.gov/epics/</a></p>
<p>MSI (Macro expansion tool) Required with Base &lt; 3.15.1</p>
<p>@url <a href="http://www.aps.anl.gov/epics/extensions/msi/index.php">http://www.aps.anl.gov/epics/extensions/msi/index.php</a></p>
<p>devLib2 &gt;= 2.9</p>
<p>@url <a href="http://epics.sourceforge.net/devlib2/">http://epics.sourceforge.net/devlib2/</a></p>
<p>RTEMS &gt;= 4.9.x, vxWorks &gt;=6.7, or Linux &gt;= 2.6.26.</p>
<h1><a class="anchor" id="hardware"></a>
Supported Hardware</h1>
<ul>
<li>Event Generators<ul>
<li>VME-EVG-230</li>
<li>PXI-EVG-220</li>
<li>PXI-EVG-230</li>
<li>cPCI-EVG-300</li>
<li>mTCA-EVM-300</li>
</ul>
</li>
<li>Event Receivers<ul>
<li>VME-EVR-230RF</li>
<li>VME-EVR-230 (non-RF)</li>
<li>PMC-EVR-230</li>
<li>cPCI-EVR-230</li>
<li>cPCI-EVRTG-300</li>
<li>cPCI-EVR-300</li>
<li>PCIe-EVR-300DC</li>
<li>mTCA-EVR-300</li>
<li>FRIB <a class="el" href="classEVR.html" title="Base interface for EVRs.">EVR</a> (not MRF product)</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="doc"></a>
Documentation</h1>
<p>User documentation can be found in the form of usage manuals for both the <a href="evr-usage.pdf">Receiver</a> and <a href="evg-usage.pdf">Generator</a></p>
<p>Those interested in the implementation for the Receiver might wish to start with mrmEvrSetupPCI() and mrmEvrSetupVME() or the <a class="el" href="classEVRMRM.html" title="Modular Register Map Event Receivers.">EVRMRM</a> class.</p>
<p>For the generator see mrmEvgSetupVME() or the ::evgMrm class.</p>
<h1><a class="anchor" id="changelog"></a>
Changelog</h1>
<h2><a class="anchor" id="v231"></a>
2.3.1 (UNRELEASED)</h2>
<ul>
<li>Add PCIe error handling to Linux kernel module (Hinko Kocevar) </li>
<li>Add DKMS and RPM configs for Linux kernel module source (Michael Abbott) </li>
<li>Fix input count on PCIe-EVR-300 and MTCA-EVR-300 (Jerzy Jamroz) </li>
<li>Added support for DLY universal modules (Javier Cereijo Garcia) </li>
<li>Add buffered timestamp capture </li>
<li>Support <a class="el" href="classPulser.html" title="A programmable delay unit.">Pulser</a> enable gating, prescalar phase/offset features of newer <a class="el" href="classEVR.html" title="Base interface for EVRs.">EVR</a> firmware (Luka Krmpotic) </li>
<li>Warn about unknown INP/OUT link options.</li>
</ul>
<h2><a class="anchor" id="v230"></a>
2.3.0 (Apr 2020)</h2>
<ul>
<li>Add support for mTCA-EVM-300 </li>
<li>Add safety checks to flash firmware update process </li>
<li>Allow iocsh redirection to file (eg. of dbior output) </li>
<li>Bug fixes and DB enhancements (Luka KrmpotiÄ‡) </li>
<li>Set SHRLIB_VERSION</li>
</ul>
<h2><a class="anchor" id="v220"></a>
2.2.0 (Oct. 2017)</h2>
<h3><a class="anchor" id="v220_compat"></a>
Incompatible changes</h3>
<ul>
<li>Requires devlib2 &gt;=2.9 </li>
<li>Some software sequencer control records have changed to accommodate sequencer support in the 300DC series EVRs. Updated cs-studio/BOY .opi files. </li>
<li>Remove support for sequencer "Automatic" (continuous) trigger mode, also Pause and Abort actions. </li>
<li>EDM files removed due to lack of maintenance.</li>
</ul>
<h3><a class="anchor" id="v220_add"></a>
Additions</h3>
<ul>
<li>Add support for mTCA-EVR-300 and PCIe-EVR-300DC. Requires firmware &gt;=207. Tested with firmware &gt;=207.6. </li>
<li>Add support for PXI-EVG-220. Support for PXI-EVG-230 was added in 2.1.0, but not documented. </li>
<li>Add driver for FRIB developed mTCA <a class="el" href="classEVR.html" title="Base interface for EVRs.">EVR</a> </li>
<li>mrmEvrSetupPCI() accepts "slot=#" in addition to PCI geographic address </li>
<li>linux: kernel module exports PCI ID table to enable automatic module loading </li>
<li>Firmware upgrade via PCIe flash access for mTCA-EVR-300 and PCIe-EVR-300DC. See <a class="el" href="classEVR.html" title="Base interface for EVRs.">EVR</a> manual for details. </li>
<li>EVG add 1 PPS source option "Sys Clk" to simulate external HW clock using system clock. </li>
<li><a class="el" href="classEVR.html" title="Base interface for EVRs.">EVR</a> add 1 PPS and timestamp source simulation.</li>
</ul>
<h2><a class="anchor" id="v210"></a>
2.1.0 (Oct. 2016)</h2>
<h3><a class="anchor" id="v210change"></a>
Incompatible changes</h3>
<ul>
<li>EVG Enable control removed. Now always enabled. </li>
<li>Incompatible changes to data buffer TX/RX APIs</li>
</ul>
<h3><a class="anchor" id="v210add"></a>
Addtions</h3>
<ul>
<li>CS-Studio BOY .opi files for EVG </li>
<li>Support for EVG on little endian targets (eg. linux x86) </li>
<li>Support for additional devices: cPCI-EVG-300, cPCI-EVR-300, and PCIe-EVR-300 </li>
<li>Add mrmEvgSoftTime() for software only time stamp distribution. </li>
<li>Support for Fine delay for UNIV I/O daughter cards. </li>
<li>Expose EVG Start of Sequence IRQ as with End of Sequence w/ a counter record. </li>
<li>Add *Label-I charactor waveform to support long form description strings. </li>
<li>Support named Events with Base &gt;= 3.15 (SCAN=Event) </li>
<li>Add global flag mrmGTIFEnable to allow generalTime current time provider to be disabled.</li>
</ul>
<h2><a class="anchor" id="v204"></a>
2.0.4 (May 2015)</h2>
<h3><a class="anchor" id="v204not"></a>
Notices</h3>
<ul>
<li>Requires devLib &gt;= 2.6 </li>
<li>Builds against EPICS Base 3.15.1 </li>
<li>Workaround to support UIO in Linux kernel &gt;=3.12 (debian kernel &gt;=3.2.0) </li>
<li>Default mrmEvrFIFOPeriod doubled to 1ms</li>
</ul>
<h3><a class="anchor" id="v204bug"></a>
Bug fixes</h3>
<ul>
<li>Fix incorrect firmware version warning message </li>
<li>Linux only. Rework interrupt handling to fully eliminate race in IRQ acknowledge. Requires new kernel module.</li>
</ul>
<h3><a class="anchor" id="v204feat"></a>
Features</h3>
<ul>
<li>Added sequence masker aSub (bit mask to replace event codes with zero) </li>
<li>Add records to show statistics of interrupt and event FIFO processing </li>
<li>Soft sequence loading stops at end of sequence event (0x7f). Further delays/events are ignored.</li>
</ul>
<h2><a class="anchor" id="v203"></a>
2.0.3 (Aug 2014)</h2>
<h3><a class="anchor" id="v203bug"></a>
Bug fixes</h3>
<ul>
<li>Linux only. Fix for ISR race condition which can leave interrupts disabled. Anyone running mrfioc2 on Linux is encouraged to update.</li>
<li>fix rounding in CML/GTX WF calculator</li>
<li>evgSoftSeq.py: fix sequences of length 1</li>
<li>seqconst: avoid memory bounds violation</li>
<li>fix EVG Univ inputs (fixed by Jonah Weber of LBNL)</li>
</ul>
<h3><a class="anchor" id="v203feat"></a>
Features</h3>
<ul>
<li>linux: emulate parallel port JTAG cable. Allows firmware update w/o the Linux GPIO userspace interface (still not built on Debian stock kernels)</li>
<li>Python helper scripts with example for NSLS2 EVG magic numbers.</li>
</ul>
<h2><a class="anchor" id="v202"></a>
2.0.2 (Aug 2013)</h2>
<h3><a class="anchor" id="v202not"></a>
Notices</h3>
<ul>
<li>I am considering removal of the <a class="el" href="classEVR.html" title="Base interface for EVRs.">EVR</a> interface class. This was originally intended to allow "similar" hardware (pre-MRM cards from MRF). However, to my knowledge this has not been done. If anyone is using this feature please contact me (<a href="#" onclick="location.href='mai'+'lto:'+'mda'+'vi'+'dsa'+'ve'+'r@g'+'ma'+'il.'+'co'+'m'; return false;">mdavi<span style="display: none;">.nosp@m.</span>dsav<span style="display: none;">.nosp@m.</span>er@gm<span style="display: none;">.nosp@m.</span>ail.<span style="display: none;">.nosp@m.</span>com</a>) or it will likely be removed in the next (2.1) release.</li>
</ul>
<h3><a class="anchor" id="v202bug"></a>
Bug fixes</h3>
<ul>
<li>Fixed issues with EVG sequencer which allowed some user inputs at inappropriate times. This could cause the sequencer to stop. Sequencer controls now validated against internal state.</li>
<li>wrong width for RVAL causes endianness issue</li>
<li>re-enable of CML output during setMode not conditional</li>
<li>Fix EVG driver init w/o hardware. This was crashing.</li>
<li>Update locking for <a class="el" href="classEVR.html" title="Base interface for EVRs.">EVR</a>. Take lock for all device support actions.</li>
<li>Fix locking error causing <a class="el" href="classEVR.html" title="Base interface for EVRs.">EVR</a> driver to hang during IOC shutdown.</li>
<li>evgSoftSeq.py handle readback of zero length sequences (the initial condition)</li>
</ul>
<h3><a class="anchor" id="v202feat"></a>
Features</h3>
<ul>
<li>Corrected the number of pulsers (delay generators) in EVRs. This adds 6 for a total of 16.</li>
<li>Updated recommended firmware version for PCI EVRs to 6.</li>
<li>Compile in VCS version or release number. Add a PV which reads this.</li>
<li>Read SFP EEPROM information (eg. module serial#, temperature, and incoming optical power). Requires firmware &gt;=5. For version 5 must be from 25 May 2012 or later.</li>
<li>Add mapping record for Prescaler reset action to the example <a class="el" href="classEVR.html" title="Base interface for EVRs.">EVR</a> databases.</li>
<li>Support and documentation for firmware update of PMC-EVR-230 devices on Linux.</li>
<li>PV with device position (VME slot or PCI BDF ids)</li>
<li>Add aSub functions to support NSLS2 injector timing sequence constructor<ul>
<li>Seq Repeat - Repeats a fixed sequence at specific intervals. Includes a bit mask to mask out certain occurences.</li>
<li>Seq Merge - Merge two or more sorted sequences while maintaining sorting.</li>
</ul>
</li>
<li>evgSoftSeq.py In addition to the previous form, the sequence editor GUI now accepts a single command line argument with the PV name prefix.</li>
<li>evgSoftSeq.py Improved connection handling.</li>
<li>configure/RELEASE Optionally include caputlog module</li>
<li>Added enable/disable control for individual <a class="el" href="classEVR.html" title="Base interface for EVRs.">EVR</a> outputs. Disabled output are mapped to Force Low.</li>
<li>On Linux, allow the <a class="el" href="classEVR.html" title="Base interface for EVRs.">EVR</a> driver to provide time to the system NTPD. Allows system clock to be synced to <a class="el" href="classEVR.html" title="Base interface for EVRs.">EVR</a> with much lower jitter then network NTP server.</li>
<li>EVG sequencer in single shot mode now shows status disabled on completion.</li>
<li>Add evrsoftgate.db which uses a hardware event to enable/disable an output using a software timer.</li>
<li>Add evgUserEvt.db which gives a "safe" software event send control.</li>
</ul>
<dl class="section warning"><dt>Warning</dt><dd>The default mapping for prescaler reset is now disabled. The included database files have been updated. Anyone who has created a custom database should update their database to include a "Reset PS" mapping record!</dd></dl>
<h2><a class="anchor" id="v201"></a>
2.0.1 (Apr. 2012)</h2>
<h3><a class="anchor" id="v201bug"></a>
Bug fixes</h3>
<ul>
<li>Fix several vxWorks build issues </li>
<li>Correct initial mapping for <a class="el" href="classEVR.html" title="Base interface for EVRs.">EVR</a> output channels to Force Low (aka. Off) </li>
<li>Fix readback of EVG sequencer run mode. </li>
<li>Limit number of soft event send retries </li>
<li>More check for EVG and <a class="el" href="classEVR.html" title="Base interface for EVRs.">EVR</a> during initialization. Should now catch old firmware versions and CSR address mapping problems. </li>
<li>Delay enabling VME interrupts for EVG until later during IOC startup. </li>
<li>Fix autosave/restore of CML output bit patterns. </li>
<li>Remove rear transition module definitions from default EVG db template </li>
<li>Fix locking issue in data buffer tx/rx. A deadlock would occur when trying to send a buffer with the link mode set to dbus only.</li>
</ul>
<h3><a class="anchor" id="v201feat"></a>
Features</h3>
<ul>
<li>Added evralias.db to facilitate creation of PV name aliases for <a class="el" href="classEVR.html" title="Base interface for EVRs.">EVR</a> delay generator channels. </li>
<li>Always reset all EVG multiplexed counters when a divider value is changed. </li>
<li>Add counter to track number of times each EVG sequencer is run. </li>
<li>Add mrmEvrForward() shell function to configure <a class="el" href="classEVR.html" title="Base interface for EVRs.">EVR</a> event forwarding to downstream EVRs.</li>
</ul>
<h2><a class="anchor" id="ver20"></a>
2.0 (Sept. 2011)</h2>
<ul>
<li>Initial release.</li>
</ul>
<dl class="section author"><dt>Author</dt><dd>Michael Davidsaver <a href="#" onclick="location.href='mai'+'lto:'+'mda'+'vi'+'dsa'+'ve'+'r@g'+'ma'+'il.'+'co'+'m'; return false;">mdavi<span style="display: none;">.nosp@m.</span>dsav<span style="display: none;">.nosp@m.</span>er@gm<span style="display: none;">.nosp@m.</span>ail.<span style="display: none;">.nosp@m.</span>com</a></dd>
<dd>
Jayesh Shah <a href="#" onclick="location.href='mai'+'lto:'+'jsh'+'ah'+'@bn'+'l.'+'gov'; return false;">jshah<span style="display: none;">.nosp@m.</span>@bnl<span style="display: none;">.nosp@m.</span>.gov</a></dd>
<dd>
Eric BjÃ¶rklund <a href="#" onclick="location.href='mai'+'lto:'+'bjo'+'rk'+'lun'+'d@'+'lan'+'l.'+'gov'; return false;">bjork<span style="display: none;">.nosp@m.</span>lund<span style="display: none;">.nosp@m.</span>@lanl<span style="display: none;">.nosp@m.</span>.gov</a></dd>
<dd>
Slejko Tom <a href="#" onclick="location.href='mai'+'lto:'+'tom'+'.s'+'lej'+'ko'+'@ps'+'i.'+'ch'; return false;">tom.s<span style="display: none;">.nosp@m.</span>lejk<span style="display: none;">.nosp@m.</span>o@psi<span style="display: none;">.nosp@m.</span>.ch</a></dd>
<dd>
Helge Brands <a href="#" onclick="location.href='mai'+'lto:'+'hel'+'ge'+'.br'+'an'+'ds@'+'ps'+'i.c'+'h'; return false;">helge<span style="display: none;">.nosp@m.</span>.bra<span style="display: none;">.nosp@m.</span>nds@p<span style="display: none;">.nosp@m.</span>si.c<span style="display: none;">.nosp@m.</span>h</a></dd>
<dd>
Saso Skube <a href="#" onclick="location.href='mai'+'lto:'+'sas'+'o.'+'sku'+'be'+'@ps'+'i.'+'ch'; return false;">saso.<span style="display: none;">.nosp@m.</span>skub<span style="display: none;">.nosp@m.</span>e@psi<span style="display: none;">.nosp@m.</span>.ch</a></dd>
<dd>
Jure Krasna <a href="#" onclick="location.href='mai'+'lto:'+'jur'+'e.'+'kra'+'sn'+'a@c'+'os'+'yla'+'b.'+'com'; return false;">jure.<span style="display: none;">.nosp@m.</span>kras<span style="display: none;">.nosp@m.</span>na@co<span style="display: none;">.nosp@m.</span>syla<span style="display: none;">.nosp@m.</span>b.com</a></dd>
<dd>
Dirk Zimoch <a href="#" onclick="location.href='mai'+'lto:'+'dir'+'k.'+'zim'+'oc'+'h@p'+'si'+'.ch'; return false;">dirk.<span style="display: none;">.nosp@m.</span>zimo<span style="display: none;">.nosp@m.</span>ch@ps<span style="display: none;">.nosp@m.</span>i.ch</a></dd>
<dd>
Anton Derbenev <a href="#" onclick="location.href='mai'+'lto:'+'ade'+'rb'+'ene'+'v@'+'bnl'+'.g'+'ov'; return false;">aderb<span style="display: none;">.nosp@m.</span>enev<span style="display: none;">.nosp@m.</span>@bnl.<span style="display: none;">.nosp@m.</span>gov</a></dd>
<dd>
Luka KrmpotiÄ‡ <a href="#" onclick="location.href='mai'+'lto:'+'luk'+'a.'+'krm'+'po'+'tic'+'@c'+'osy'+'la'+'b.c'+'om'; return false;">luka.<span style="display: none;">.nosp@m.</span>krmp<span style="display: none;">.nosp@m.</span>otic@<span style="display: none;">.nosp@m.</span>cosy<span style="display: none;">.nosp@m.</span>lab.c<span style="display: none;">.nosp@m.</span>om</a> </dd></dl>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
